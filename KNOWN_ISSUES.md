# Known Issues

This document tracks bugs discovered through various analysis methods including property-based testing, concurrency testing, and hexagonal architecture analysis.

## Bug Tracking

| ID         | Status      | Source           | Description                                                                                                                                                                                                                                                                                                                                                                                                                                         | Location                                                                                                     |
| ---------- | ----------- | ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| HEADER-001 | wontfix     | concurrency-test | Potential race condition: Header stripping and injection are not atomic. Verified with concurrency tests (`TestHeaderStripping_Concurrency_NoRaceCondition`, `TestHeaderStripping_Concurrency_PropertyBased`) - no race conditions found. Each HTTP request is handled by a single goroutine with request-scoped headers (no shared mutable state). Not a real issue in practice.                                                                   | `internal/adapters/driving/caddy/plugin.go:890-954`                                                          |
| HEADER-002 | fixed       | property-test    | Case-insensitive matching now uses explicit `http.CanonicalHeaderKey()` before all `Del()` and `Set()` operations. Previously relied on Go's internal canonicalization. Fixed by adding explicit canonicalization in `applyAttributeHeaders()` and `applyAttributeHeadersForSP()` for both single-SP and multi-SP modes. Tests: `TestHeaderStripping_Property_NonASCIICharacters`, `TestHeaderStripping_Property_CaseInsensitiveMatching_NonASCII`. | `internal/adapters/driving/caddy/plugin.go:895,900,955,973,2054,2059,2111,2130`                              |
| HEADER-003 | fixed       | hex-analysis     | Default strip behavior inconsistency: Single-SP defaults to `strip=true` (via `shouldStripAttributeHeaders()`), multi-SP defaults to `strip=false` (when `StripAttributeHeaders` is nil). Fixed by adding `shouldStripAttributeHeadersForSP()` helper function that defaults to `true` when nil.                                                                                                                                                    | `internal/adapters/driving/caddy/plugin.go:982-988,2039`                                                     |
| HEADER-004 | confirmed   | hex-analysis     | Headers stripped but not replaced on mapping error: If `MapAttributesToHeadersWithPrefix` fails after stripping (line 941-948), headers are stripped but never replaced. This is acceptable behavior since config errors should be caught at startup via `Validate()`. Test: `TestHeaderStripping_Property_MappingErrorHandling`.                                                                                                                   | `internal/adapters/driving/caddy/plugin.go:940-948`                                                          |
| HEADER-005 | confirmed   | hex-analysis     | Entitlement headers stripped before lookup: Entitlement headers are stripped before entitlement lookup. If lookup fails (non-ErrEntitlementNotFound error), headers are stripped but not replaced. This is intentional and correct behavior - entitlements are supplementary, and we strip spoofed headers for security even if entitlements aren't available.                                                                                      | `internal/adapters/driving/caddy/plugin.go:897-900,918-933`                                                  |
| HEADER-006 | confirmed   | hex-analysis     | Session nil after stripping: If session becomes nil after stripping (line 903), headers are stripped but never replaced. This is correct behavior for unauthenticated requests - we strip spoofed headers for security but don't set legitimate headers since there's no session data. Test: `TestHeaderStripping_Property_SessionNilHandling`.                                                                                                     | `internal/adapters/driving/caddy/plugin.go:890-904`                                                          |
| HEADER-007 | unconfirmed | hex-analysis     | Prefix case canonicalization: `ApplyHeaderPrefix()` returns non-canonicalized header names (e.g., "x-saml-User" if prefix is lowercase). While `http.Header.Del()` and `Set()` both canonicalize internally, property-based testing could surface edge cases where prefix/headerName combinations with mixed case don't match correctly. The adapter layer relies on Go's canonicalization rather than ensuring canonical form upfront.             | `internal/adapters/driving/caddy/config.go:360-365`, `internal/adapters/driving/caddy/plugin.go:894-895,970` |
| HEADER-008 | unconfirmed | hex-analysis     | Header name consistency between Del() and Set(): Header names used for `Del()` (line 895, 899) come from `ApplyHeaderPrefix()`, while names for `Set()` come from `MapAttributesToHeadersWithPrefix()` (line 941) or `ApplyHeaderPrefix()` again (line 970). Both should match since they use the same prefix logic, but property-based testing could verify this invariant across all case variations and prefix combinations.                     | `internal/adapters/driving/caddy/plugin.go:894-895,941,970`                                                  |

## Status Legend

- **unconfirmed**: Potential issue identified but not yet verified
- **confirmed**: Issue verified and reproducible
- **fixed**: Issue has been resolved
- **wontfix**: Issue acknowledged but will not be fixed (with justification)

## Source Legend

- **hex-analysis**: Discovered through hexagonal architecture analysis
- **property-test**: Discovered through property-based testing
- **concurrency-test**: Discovered through concurrent access testing
- **manual**: Discovered through manual testing or code review
